<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Import Markdown</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { margin-top: 10px; padding: 8px 12px; font-size: 14px; }
    .version { font-size: 12px; color: #555; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h3>Import Markdown as Trello Cards</h3>
  <div class="version">Version: 0.0.9</div>

  <input type="file" id="fileInput" accept=".md">
  <br>
  <button id="createBtn" disabled>Create Cards</button>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script>
    const t = window.TrelloPowerUp.iframe();
    let markdownContent = '';

    const fileInput = document.getElementById('fileInput');
    const createBtn = document.getElementById('createBtn');

    fileInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        markdownContent = e.target.result;
        createBtn.disabled = false;
      };
      reader.readAsText(file);
    });

    createBtn.addEventListener('click', async function() {
      if (!markdownContent) return;

      try {
        // Get the current board id
        const board = await t.board('id');

        // Send Markdown to backend
        const response = await fetch('https://markdown-importer.vercel.app/import-markdown', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ boardId: board.id, markdown: markdownContent })
        });

        const data = await response.json();
        if (data.success) {
          alert('Markdown imported successfully!');
          t.closePopup();
        } else {
          alert('Error importing cards: ' + (data.error || 'Unknown'));
        }

      } catch (err) {
        console.error(err);
        alert('Error importing cards. See console.');
      }
    });
  </script>
</body>
</html>
